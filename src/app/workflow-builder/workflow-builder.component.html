<div class="workflow-builder" [class.dark]="darkMode">
  <!-- Toolbar -->
  <div class="toolbar">
    <div class="btn-group">
      <button (click)="resetView()" title="Reset View"><svg width="18" height="18" fill="none" stroke="currentColor"
          stroke-width="2" viewBox="0 0 24 24">
          <path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8" />
          <path d="M3 3v5h5" />
        </svg> <span>Reset</span></button>
      <button (click)="undo()" title="Undo (Ctrl+Z)"><svg width="18" height="18" fill="none" stroke="currentColor"
          stroke-width="2" viewBox="0 0 24 24">
          <path d="M9 14L4 9l5-5" />
          <path d="M20 20v-7a4 4 0 0 0-4-4H4" />
        </svg></button>
      <button (click)="redo()" title="Redo (Ctrl+Shift+Z)"><svg width="18" height="18" fill="none" stroke="currentColor"
          stroke-width="2" viewBox="0 0 24 24">
          <path d="M15 14l5-5-5-5" />
          <path d="M4 20v-7a4 4 0 0 1 4-4h12" />
        </svg></button>
    </div>

    <div class="btn-group">
      <button (click)="validate()" [class.valid]="isValid===true" [class.invalid]="isValid===false"
        title="Validate Workflow">
        <svg width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
          <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14" />
          <polyline points="22 4 12 14.01 9 11.01" />
        </svg>
        <span>Validate</span>
      </button>
      <button (click)="saveWorkflow()"><svg width="18" height="18" fill="none" stroke="currentColor" stroke-width="2"
          viewBox="0 0 24 24">
          <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z" />
          <path d="M17 21v-8H7v8" />
          <path d="M7 3v5h8" />
        </svg> <span>Save</span></button>
      <button (click)="loadWorkflow()"><svg width="18" height="18" fill="none" stroke="currentColor" stroke-width="2"
          viewBox="0 0 24 24">
          <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" />
          <path d="M17 8l-5-5-5 5" />
          <path d="M12 3v12" />
        </svg> <span>Load</span></button>
    </div>

    <button (click)="toggleTheme()"><svg *ngIf="!darkMode" width="18" height="18" fill="none" stroke="currentColor"
        stroke-width="2" viewBox="0 0 24 24">
        <circle cx="12" cy="12" r="5" />
        <path
          d="M12 1v2m0 18v2M4.22 4.22l1.42 1.42m12.72 12.72l1.42 1.42M1 12h2m18 0h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42" />
      </svg><svg *ngIf="darkMode" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2"
        viewBox="0 0 24 24">
        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z" />
      </svg></button>
  </div>

  <div class="main-area">
    <aside class="palette">
      <h3>Components</h3>
      <div class="palette-list">
        <div *ngFor="let type of nodeTypes" draggable="true" (dragstart)="onDragStart($event, type)"
          class="palette-item">
          <div class="palette-icon" [ngSwitch]="type">
            <svg *ngSwitchCase="'Start'" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2"
              viewBox="0 0 24 24">
              <circle cx="12" cy="12" r="10" />
              <path d="M12 8l4 4-4 4M8 12h8" />
            </svg>
            <svg *ngSwitchCase="'Task'" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2"
              viewBox="0 0 24 24">
              <rect x="3" y="3" width="18" height="18" rx="2" />
              <path d="M3 9h18M9 21V9" />
            </svg>
            <svg *ngSwitchCase="'Decision'" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2"
              viewBox="0 0 24 24">
              <path d="M12 2L2 12l10 10 10-10L12 2z" />
            </svg>
            <svg *ngSwitchCase="'End'" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2"
              viewBox="0 0 24 24">
              <circle cx="12" cy="12" r="10" />
              <path d="M15 9l-6 6M9 9l6 6" />
            </svg>
          </div>
          <span>{{type}}</span>
        </div>
      </div>
    </aside>

    <section class="canvas" #canvasContainer (wheel)="onZoom($event)" (mousedown)="onCanvasMouseDown($event)"
      tabindex="0">
      <div class="canvas-transform"
        [style.transform]="'translate(' + canvasTranslate.x + 'px,' + canvasTranslate.y + 'px) scale(' + canvasScale + ')'">
        <svg class="connections" width="5000" height="5000">
          <defs>
            <marker id="arrow" markerWidth="6" markerHeight="6" refX="6" refY="3" orient="auto">
              <path d="M0,0 L6,3 L0,6 Z" fill="currentColor" />
            </marker>
          </defs>
          <g *ngFor="let c of connections" class="conn-group"
            [class.selected]="selectedType==='conn' && selectedId===c.from+'->'+c.to"
            (mousedown)="selectConn($event, c)">
            <path [attr.d]="getConnectionPath(c.from, c.to)" fill="none" stroke="transparent" stroke-width="20" />
            <path [attr.d]="getConnectionPath(c.from, c.to)" fill="none" stroke-width="3" marker-end="url(#arrow)" />
          </g>
          <path *ngIf="activeConnection" [attr.d]="getConnectionPath(activeConnection.from, null)" fill="none"
            stroke="currentColor" stroke-width="2" stroke-dasharray="5,5" />
        </svg>

        <div class="node" *ngFor="let node of nodes" [style.left.px]="node.position.x" [style.top.px]="node.position.y"
          [class.selected]="selectedId===node.id && selectedType==='node'" (mousedown)="onNodeMouseDown($event, node)"
          (mouseup)="onNodeMouseUp($event, node)" tabindex="0">
          <div class="node-header">
            <span class="node-type-tag">{{node.type}}</span>
            <button class="delete-btn" (click)="deleteSelected()"
              *ngIf="selectedId===node.id && selectedType==='node'"><svg width="14" height="14" fill="none"
                stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                <path d="M3 6h18M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6M8 6V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2" />
              </svg></button>
          </div>
          <div class="node-content">
            <strong>{{node.title}}</strong>
            <p>{{node.label}}</p>
          </div>
          <div class="handle" (mousedown)="onHandleMouseDown($event, node)"></div>
        </div>
      </div>
    </section>

    <!-- Context Panel -->
    <aside class="config-panel" *ngIf="selectedId">
      <h3>{{selectedType === 'node' ? 'Node' : 'Connection'}} Settings</h3>
      <div *ngIf="selectedType === 'node' && getSelectedNode() as node" class="config-form">
        <label>Title</label>
        <input [(ngModel)]="node.title" (ngModelChange)="saveHistory()">
        <label>Description</label>
        <textarea [(ngModel)]="node.label" (ngModelChange)="saveHistory()" rows="4"></textarea>
        <button class="danger-btn" (click)="deleteSelected()">Delete Node</button>
      </div>
      <div *ngIf="selectedType === 'conn'" class="config-form">
        <p>Connecting: <code>{{selectedId}}</code></p>
        <button class="danger-btn" (click)="deleteSelected()">Delete Connection</button>
      </div>
    </aside>
  </div>
</div>